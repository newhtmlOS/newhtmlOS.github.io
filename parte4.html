<script id="weather-app-v2">
(function(){
  const ICONS = {
    sun: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M2 12h2M20 12h2M4.9 4.9l1.4 1.4M17.7 17.7l1.4 1.4M4.9 19.1l1.4-1.4M17.7 6.3l1.4-1.4"/></svg>',
    cloud: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M5 16a5 5 0 0 1 3-9 7 7 0 0 1 13 3 4 4 0 0 1-1 8H7"/></svg>',
    rain: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M5 16a5 5 0 0 1 3-9 7 7 0 0 1 13 3 4 4 0 0 1-1 8H7"/><path d="M8 19v2M12 19v2M16 19v2"/></svg>',
    storm: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M5 16a5 5 0 0 1 3-9 7 7 0 0 1 13 3 4 4 0 0 1-1 8H7"/><path d="M13 11l-2 4h3l-2 4"/></svg>',
    snow: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2v20M4 6l16 12M4 18L20 6"/></svg>',
    mist: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 12h18M3 16h18M6 8h12"/></svg>',
  };

  function qs(s, el=document){ return el.querySelector(s); }
  function insertAfter(n, ref){ ref.parentNode.insertBefore(n, ref.nextSibling); }
  function isMobile(){ return matchMedia('(max-width: 900px)').matches; }

  function wxMap(code){
    const m = {
      0:['Céu limpo','sun'],1:['Poucas nuvens','sun'],2:['Parcialmente nublado','cloud'],3:['Nublado','cloud'],
      45:['Névoa','mist'],48:['Névoa gelada','mist'],
      51:['Garoa fraca','rain'],53:['Garoa','rain'],55:['Garoa forte','rain'],
      61:['Chuva fraca','rain'],63:['Chuva','rain'],65:['Chuva forte','rain'],
      66:['Chuva congelante fraca','rain'],67:['Chuva congelante forte','rain'],
      71:['Neve fraca','snow'],73:['Neve','snow'],75:['Neve forte','snow'],
      80:['Aguaceiro fraco','rain'],81:['Aguaceiro','rain'],82:['Aguaceiro forte','rain'],
      95:['Trovoadas','storm'],96:['Trovoadas c/ granizo','storm'],99:['Trovoadas c/ granizo forte','storm']
    };
    return m[code] || ['Tempo variável','cloud'];
  }

  async function fetchByCoords(lat, lon){
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,relative_humidity_2m,precipitation_probability&daily=temperature_2m_max,temperature_2m_min&forecast_days=1`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('meteo');
    return r.json();
  }

  async function geocodeCity(name){
    const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=pt`;
    const r = await fetch(url);
    const j = await r.json();
    if(!j.results || !j.results.length) throw new Error('no-city');
    const c = j.results[0];
    return {lat:c.latitude, lon:c.longitude, name:c.name};
  }

  async function reverseGeocode(lat, lon){
    try{
      const url = `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&count=1&language=pt`;
      const r = await fetch(url);
      const j = await r.json();
      if(j.results && j.results.length) return j.results[0].name;
    }catch(e){}
    return null;
  }

})();
</script>